<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>CORS.NINJA</title>

    <script type="text/javascript" src="js/knockout-3.2.0.js"></script>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="container">
 <div class="hero-unit">
      <h1>Welcome to OpenStack Meeting Analytics <br>
      <small> Click <a id="hereButton">here</a> to see number of meetings for each project</small> </h1>
</div>
 <table>
    <thead><tr><th>Name</th><th>Count</th></tr></thead>
    <tbody data-bind="foreach: projects">
        <tr><td data-bind="text: name"></td><td data-bind="text: countMeetings"></td></tr>
    </tbody>
  </table>
</div>

<script src="http://code.jquery.com/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/knockout-3.2.0.js"></script>
</body>

<script type="application/javascript">

    var html_data;
    var _data;
    var projects;
    var items;
    var viewModel;

    var Meeting = function(_meeting,_year,_project){
        this.name = _meeting;
        this.year = _year;
        this.project = _project;
    }

    var Year = function(project,_year){
        this.year = _year;
        this.project = project;
        this.meetings = ko.observableArray();
        this.count = ko.computed(function(){
            var previous = "";
            var name = "";
            var _count =0;
            ko.utils.arrayForEach(this.meetings(), function(meeting) {
                var dash= meeting.name.indexOf("-");
                var per = meeting.name.indexOf(".",dash);
                var last = meeting.name.indexOf(".", per+1);
                //console.log("Meeting: ", meeting.name ,dash,per,last);

                var name = meeting.name.substring(0,last);

//                console.log("Name: " + name);
                if(name != previous){
                    _count ++ ;
                    previous = name;
                }
            });
            return _count;
        },this);

        this.addMeeting = function(meeting){
            this.meetings.push(meeting);
        };

        this.loadMeetings = function(project, year){
            var self = this;

            $.getJSON("/api/GET", {url: "http://eavesdrop.openstack.org/meetings/"+project.name + year}, function(data){
                _data = data;
                html_data= $.parseHTML(data.body);
                $(html_data).find("tr:gt(2)").find("td a").each(function(idx,item){
                    var n = new Meeting(item.text,self,project);
                    self.addMeeting(n);
             });
         })
       }
    }

    var Project = function(name) {
        this.name = name;
        this.years = ko.observableArray();
        this.countMeetings = ko.computed(function(){
            var self = this;
            var total = 0;
            ko.utils.arrayForEach(this.years(), function(year) {
                total += year.count();
          });
            console.log("TOTAL ", self.name , total);
            return total;
        },this);

        this.loadYears = function(){
            var self  = this;
            $.getJSON("/api/GET", {url: "http://eavesdrop.openstack.org/meetings/"+self.name}, function(data){
                _data = data;
                html_data= $.parseHTML(data.body);
                $(html_data).find("tr:gt(2)").find("td a").each(function(idx,item){
                    console.log("YEAR: ", item.text, self.name);
                    var y = new Year(item.text,self)
                    y.loadMeetings(self,item.text);
                    self.years.push(y);
                });

                // console.log(html_data);
                // Now use this data to update your view models,
                // and Knockout will update your UI automatically
                // console.log("Received data", data);
            })

        };

        this.addYear = function(year) {
            this.years.push(new Year(year));
        }.bind(this);

    };

function readyFn(){

    // The view model is an abstract description of the state of the UI, but without any knowledge of the UI technology (HTML)

    viewModel = {
        projects: ko.observableArray(),
        showRenderTimes: ko.observable(false),
        addProject: function(name){
            var a = new Project(name);
            a.loadYears();
            this.projects.push(a)
        }
    };

    $.getJSON("/api/GET", {url: "http://eavesdrop.openstack.org/meetings/"}, function(data){
        _data = data;
        html_data= $.parseHTML(data.body);
        $(html_data).find("tr:gt(2)").find("td a").each(function(idx,item){
            viewModel.addProject(item.text);
        });
//            viewModel.addProject($(html_data).find("tr:gt(2)").find("td a")[0].text);
        // $(".container")[0].append(html_data);

        // console.log(html_data);
        // Now use this data to update your view models,
        // and Knockout will update your UI automatically
//        console.log("Received data", data);
    })


    ko.applyBindings(viewModel);
// Define a "Person" class that tracks its own name and children, and has a method to add a new child
}

    $("#hereButton").click(readyFn);
//
//$( document ).ready(
//    function() {
//        console.log("Ready");
//        $("#hereButton").click(readyFn);
//    }
//);

</script>
</html>